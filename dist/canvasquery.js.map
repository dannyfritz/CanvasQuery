{
  "version": 3,
  "sources": [
    "node_modules/browserify/node_modules/browser-pack/_prelude.js",
    "node_modules/fast-apply/index.js",
    "src/canvasquery.js"
  ],
  "names": [],
  "mappings": "AAAA;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA",
  "file": "generated.js",
  "sourceRoot": "./src",
  "sourcesContent": [
    "(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})",
    "module.exports = fastApply;\r\n\r\nfunction fastApply(fn, context, args) {\r\n    \r\n    switch (args ? args.length : 0) {\r\n        case 0:\r\n            return context ? fn.call(context) : fn();\r\n        case 1:\r\n            return context ? fn.call(context, args[0]) : fn(args[0]);\r\n        case 2:\r\n            return context ? fn.call(context, args[0], args[1]) : fn(args[0], args[1]);\r\n        case 3:\r\n            return context ? fn.call(context, args[0], args[1], args[2]) : fn(args[0], args[1], args[2]);\r\n        case 4:\r\n            return context ? fn.call(context, args[0], args[1], args[2], args[3]) : fn(args[0], args[1], args[2], args[3]);\r\n        case 5:\r\n            return context ? fn.call(context, args[0], args[1], args[2], args[3], args[4]) : fn(args[0], args[1], args[2], args[3], args[4]);\r\n        default:\r\n            return fn.apply(context, args);\r\n    }\r\n    \r\n}",
    "/*\r\n\r\n  Canvas Query 1.24\r\n\r\n  http://canvasquery.com\r\n\r\n  (c) 2012-2015 http://rezoner.net\r\n\r\n  Canvas Query may be freely distributed under the MIT license.\r\n\r\n  ! fixed color parsers\r\n\r\n*/\r\n\r\nvar fastApply = require('fast-apply')\r\n\r\nvar Canvas = window.HTMLCanvasElement;\r\nvar Image = window.HTMLImageElement;\r\nvar COCOONJS = navigator.isCocoonJS;\r\n\r\nvar cq = function(selector) {\r\n  if (arguments.length === 0) {\r\n    var canvas = cq.createCanvas(window.innerWidth, window.innerHeight);\r\n    window.addEventListener(\"resize\", function() {\r\n      // canvas.width = window.innerWidth;\r\n      // canvas.height = window.innerHeight;\r\n    });\r\n  } else if (typeof selector === \"string\") {\r\n    var canvas = document.querySelector(selector);\r\n  } else if (typeof selector === \"number\") {\r\n    var canvas = cq.createCanvas(arguments[0], arguments[1]);\r\n  } else if (selector instanceof Image) {\r\n    var canvas = cq.createCanvas(selector);\r\n  } else if (selector instanceof cq.Layer) {\r\n    return selector;\r\n  } else {\r\n    var canvas = selector;\r\n  }\r\n\r\n  return new cq.Layer(canvas);\r\n};\r\n\r\ncq.lineSpacing = 1.0;\r\ncq.defaultFont = \"Arial\";\r\n\r\ncq.cocoon = function(selector) {\r\n  if (arguments.length === 0) {\r\n    var canvas = cq.createCocoonCanvas(window.innerWidth, window.innerHeight);\r\n    window.addEventListener(\"resize\", function() {});\r\n  } else if (typeof selector === \"string\") {\r\n    var canvas = document.querySelector(selector);\r\n  } else if (typeof selector === \"number\") {\r\n    var canvas = cq.createCocoonCanvas(arguments[0], arguments[1]);\r\n  } else if (selector instanceof Image) {\r\n    var canvas = cq.createCocoonCanvas(selector);\r\n  } else if (selector instanceof cq.Layer) {\r\n    return selector;\r\n  } else {\r\n    var canvas = selector;\r\n  }\r\n\r\n  return new cq.Layer(canvas);\r\n}\r\n\r\n\r\ncq.extend = function() {\r\n  for (var i = 1; i < arguments.length; i++) {\r\n    for (var j in arguments[i]) {\r\n      arguments[0][j] = arguments[i][j];\r\n    }\r\n  }\r\n\r\n  return arguments[0];\r\n};\r\n\r\ncq.augment = function() {\r\n  for (var i = 1; i < arguments.length; i++) {\r\n    _.extend(arguments[0], arguments[i]);\r\n    arguments[i](arguments[0]);\r\n  }\r\n};\r\n\r\ncq.distance = function(x1, y1, x2, y2) {\r\n  if (arguments.length > 2) {\r\n    var dx = x1 - x2;\r\n    var dy = y1 - y2;\r\n\r\n    return Math.sqrt(dx * dx + dy * dy);\r\n  } else {\r\n    return Math.abs(x1 - y1);\r\n  }\r\n};\r\n\r\ncq.extend(cq, {\r\n\r\n  smoothing: true,\r\n\r\n  blend: function(below, above, mode, mix) {\r\n\r\n    if (typeof mix === \"undefined\") mix = 1;\r\n\r\n    var below = cq(below);\r\n    var mask = below.clone();\r\n    var above = cq(above);\r\n\r\n    below.save();\r\n    below.globalAlpha(mix);\r\n    below.globalCompositeOperation(mode);\r\n    below.drawImage(above.canvas, 0, 0);\r\n    below.restore();\r\n\r\n    mask.save();\r\n    mask.globalCompositeOperation(\"source-in\");\r\n    mask.drawImage(below.canvas, 0, 0);\r\n    mask.restore();\r\n\r\n    return mask;\r\n  },\r\n\r\n  matchColor: function(color, palette) {\r\n    var rgbPalette = [];\r\n\r\n    for (var i = 0; i < palette.length; i++) {\r\n      rgbPalette.push(cq.color(palette[i]));\r\n    }\r\n\r\n    var imgData = cq.color(color);\r\n\r\n    var difList = [];\r\n    for (var j = 0; j < rgbPalette.length; j++) {\r\n      var rgbVal = rgbPalette[j];\r\n      var rDif = Math.abs(imgData[0] - rgbVal[0]),\r\n        gDif = Math.abs(imgData[1] - rgbVal[1]),\r\n        bDif = Math.abs(imgData[2] - rgbVal[2]);\r\n      difList.push(rDif + gDif + bDif);\r\n    }\r\n\r\n    var closestMatch = 0;\r\n    for (var j = 0; j < palette.length; j++) {\r\n      if (difList[j] < difList[closestMatch]) {\r\n        closestMatch = j;\r\n      }\r\n    }\r\n\r\n    return palette[closestMatch];\r\n  },\r\n\r\n  temp: function(width, height) {\r\n    if (!this.tempLayer) {\r\n      this.tempLayer = cq(1, 1);\r\n    }\r\n\r\n    if (width instanceof Image) {\r\n      this.tempLayer.width = width.width;\r\n      this.tempLayer.height = width.height;\r\n      this.tempLayer.context.drawImage(width, 0, 0);\r\n    } else if (width instanceof Canvas) {\r\n      this.tempLayer.width = width.width;\r\n      this.tempLayer.height = width.height;\r\n      this.tempLayer.context.drawImage(width, 0, 0);\r\n    } else if (width instanceof CanvasQuery.Layer) {\r\n      this.tempLayer.width = width.width;\r\n      this.tempLayer.height = width.height;\r\n      this.tempLayer.context.drawImage(width.canvas, 0, 0);\r\n    } else {\r\n      this.tempLayer.width = width;\r\n      this.tempLayer.height = height;\r\n    }\r\n\r\n    return this.tempLayer;\r\n  },\r\n\r\n  wrapValue: function(value, min, max) {\r\n    if (value < min) return max + (value % max);\r\n    if (value >= max) return value % max;\r\n    return value;\r\n  },\r\n\r\n  limitValue: function(value, min, max) {\r\n    return value < min ? min : value > max ? max : value;\r\n  },\r\n\r\n  mix: function(a, b, amount) {\r\n    return a + (b - a) * amount;\r\n  },\r\n\r\n  hexToRgb: function(hex) {\r\n    if (hex.length === 7) return ['0x' + hex[1] + hex[2] | 0, '0x' + hex[3] + hex[4] | 0, '0x' + hex[5] + hex[6] | 0];\r\n    else return ['0x' + hex[1] + hex[1] | 0, '0x' + hex[2] + hex[2] | 0, '0x' + hex[3] + hex[3] | 0];\r\n  },\r\n\r\n  rgbToHex: function(r, g, b) {\r\n    return \"#\" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1, 7);\r\n  },\r\n\r\n  /* author: http://mjijackson.com/ */\r\n\r\n  rgbToHsl: function(r, g, b) {\r\n\r\n    if (r instanceof Array) {\r\n      b = r[2];\r\n      g = r[1];\r\n      r = r[0];\r\n    }\r\n\r\n    r /= 255, g /= 255, b /= 255;\r\n    var max = Math.max(r, g, b),\r\n      min = Math.min(r, g, b);\r\n    var h, s, l = (max + min) / 2;\r\n\r\n    if (max == min) {\r\n      h = s = 0; // achromatic\r\n    } else {\r\n      var d = max - min;\r\n      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);\r\n      switch (max) {\r\n        case r:\r\n          h = (g - b) / d + (g < b ? 6 : 0);\r\n          break;\r\n        case g:\r\n          h = (b - r) / d + 2;\r\n          break;\r\n        case b:\r\n          h = (r - g) / d + 4;\r\n          break;\r\n      }\r\n      h /= 6;\r\n    }\r\n\r\n    return [h, s, l];\r\n  },\r\n\r\n  /* author: http://mjijackson.com/ */\r\n\r\n  hue2rgb: function(p, q, t) {\r\n    if (t < 0) t += 1;\r\n    if (t > 1) t -= 1;\r\n    if (t < 1 / 6) return p + (q - p) * 6 * t;\r\n    if (t < 1 / 2) return q;\r\n    if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;\r\n    return p;\r\n  },\r\n\r\n  hslToRgb: function(h, s, l) {\r\n    var r, g, b;\r\n\r\n    if (s == 0) {\r\n      r = g = b = l; // achromatic\r\n    } else {\r\n\r\n      var q = l < 0.5 ? l * (1 + s) : l + s - l * s;\r\n      var p = 2 * l - q;\r\n      r = this.hue2rgb(p, q, h + 1 / 3);\r\n      g = this.hue2rgb(p, q, h);\r\n      b = this.hue2rgb(p, q, h - 1 / 3);\r\n    }\r\n\r\n    return [r * 255 | 0, g * 255 | 0, b * 255 | 0];\r\n  },\r\n\r\n  rgbToHsv: function(r, g, b) {\r\n    if (r instanceof Array) {\r\n      b = r[2];\r\n      g = r[1];\r\n      r = r[0];\r\n    }\r\n\r\n    r = r / 255, g = g / 255, b = b / 255;\r\n    var max = Math.max(r, g, b),\r\n      min = Math.min(r, g, b);\r\n    var h, s, v = max;\r\n\r\n    var d = max - min;\r\n    s = max == 0 ? 0 : d / max;\r\n\r\n    if (max == min) {\r\n      h = 0; // achromatic\r\n    } else {\r\n      switch (max) {\r\n        case r:\r\n          h = (g - b) / d + (g < b ? 6 : 0);\r\n          break;\r\n        case g:\r\n          h = (b - r) / d + 2;\r\n          break;\r\n        case b:\r\n          h = (r - g) / d + 4;\r\n          break;\r\n      }\r\n      h /= 6;\r\n    }\r\n\r\n    return [h, s, v];\r\n  },\r\n\r\n  hsvToRgb: function(h, s, v) {\r\n    var r, g, b;\r\n\r\n    var i = Math.floor(h * 6);\r\n    var f = h * 6 - i;\r\n    var p = v * (1 - s);\r\n    var q = v * (1 - f * s);\r\n    var t = v * (1 - (1 - f) * s);\r\n\r\n    switch (i % 6) {\r\n      case 0:\r\n        r = v, g = t, b = p;\r\n        break;\r\n      case 1:\r\n        r = q, g = v, b = p;\r\n        break;\r\n      case 2:\r\n        r = p, g = v, b = t;\r\n        break;\r\n      case 3:\r\n        r = p, g = q, b = v;\r\n        break;\r\n      case 4:\r\n        r = t, g = p, b = v;\r\n        break;\r\n      case 5:\r\n        r = v, g = p, b = q;\r\n        break;\r\n    }\r\n\r\n    return [r * 255, g * 255, b * 255];\r\n  },\r\n\r\n  color: function() {\r\n    var result = new cq.Color();\r\n    result.parse(arguments[0], arguments[1]);\r\n    return result;\r\n  },\r\n\r\n  poolArray: [],\r\n\r\n  pool: function() {\r\n\r\n    if (!this.poolArray.length) {\r\n      for (var i = 0; i < 100; i++) {\r\n        this.poolArray.push(this.createCanvas(1, 1));\r\n      }\r\n    }\r\n\r\n    return this.poolArray.pop();\r\n\r\n  },\r\n\r\n  createCanvas: function(width, height) {\r\n    var result = document.createElement(\"canvas\");\r\n\r\n    if (arguments[0] instanceof Image || arguments[0] instanceof Canvas) {\r\n      var image = arguments[0];\r\n      result.width = image.width;\r\n      result.height = image.height;\r\n      result.getContext(\"2d\").drawImage(image, 0, 0);\r\n    } else {\r\n      result.width = width;\r\n      result.height = height;\r\n    }\r\n\r\n\r\n    return result;\r\n  },\r\n\r\n  createCocoonCanvas: function(width, height) {\r\n    var result = document.createElement(\"screencanvas\");\r\n\r\n    if (arguments[0] instanceof Image) {\r\n      var image = arguments[0];\r\n      result.width = image.width;\r\n      result.height = image.height;\r\n      result.getContext(\"2d\").drawImage(image, 0, 0);\r\n    } else {\r\n      result.width = width;\r\n      result.height = height;\r\n    }\r\n\r\n    return result;\r\n  },\r\n\r\n  createImageData: function(width, height) {\r\n    return cq.createCanvas(width, height).getContext(\"2d\").createImageData(width, height);\r\n  }\r\n\r\n});\r\n\r\ncq.Layer = function(canvas) {\r\n  this.context = canvas.getContext(\"2d\");\r\n  this.canvas = canvas;\r\n  this.alignX = 0;\r\n  this.alignY = 0;\r\n  this.aligned = false;\r\n  this.update();\r\n};\r\n\r\ncq.Layer.prototype = {\r\n\r\n  update: function() {\r\n    this.context.webkitImageSmoothingEnabled = cq.smoothing;\r\n    this.context.mozImageSmoothingEnabled = cq.smoothing;\r\n    this.context.msImageSmoothingEnabled = cq.smoothing;\r\n    this.context.imageSmoothingEnabled = cq.smoothing;\r\n\r\n    if (COCOONJS) Cocoon.Utils.setAntialias(cq.smoothing);\r\n  },\r\n\r\n  appendTo: function(selector) {\r\n    if (typeof selector === \"object\") {\r\n      var element = selector;\r\n    } else {\r\n      var element = document.querySelector(selector);\r\n    }\r\n\r\n    element.appendChild(this.canvas);\r\n\r\n    return this;\r\n  },\r\n\r\n  a: function(a) {\r\n    if (arguments.length) {\r\n      this.previousAlpha = this.globalAlpha();\r\n      return this.globalAlpha(a);\r\n    } else\r\n      return this.globalAlpha();\r\n  },\r\n\r\n  ra: function() {\r\n    return this.a(this.previousAlpha);\r\n  },\r\n  /*\r\n      drawImage: function() {\r\n\r\n        if (!this.alignX && !this.alignY) {\r\n          this.context.call\r\n        }\r\n\r\n          return this;\r\n\r\n\r\n      },\r\n\r\n      restore: function() {\r\n        this.context.restore();\r\n        this.alignX = 0;\r\n        this.alignY = 0;\r\n      },\r\n      */\r\n\r\n  realign: function() {\r\n\r\n    this.alignX = this.prevAlignX;\r\n    this.alignY = this.prevAlignY;\r\n\r\n    return this;\r\n\r\n  },\r\n\r\n  align: function(x, y) {\r\n\r\n    if (typeof y === \"undefined\") y = x;\r\n\r\n    this.alignX = x;\r\n    this.alignY = y;\r\n\r\n    return this;\r\n  },\r\n\r\n\r\n  /* save translate align rotate scale */\r\n\r\n  stars: function(x, y, alignX, alignY, rotation, scaleX, scaleY) {\r\n\r\n    if (typeof alignX === \"undefined\") alignX = 0.5;\r\n    if (typeof alignY === \"undefined\") alignY = 0.5;\r\n    if (typeof rotation === \"undefined\") rotation = 0;\r\n    if (typeof scaleX === \"undefined\") scaleX = 1.0;\r\n    if (typeof scaleY === \"undefined\") scaleY = scaleX;\r\n\r\n    this.save();\r\n    this.translate(x, y);\r\n    this.align(alignX, alignY);\r\n    this.rotate(rotation);\r\n    this.scale(scaleX, scaleY);\r\n\r\n    return this;\r\n  },\r\n\r\n  tars: function(x, y, alignX, alignY, rotation, scaleX, scaleY) {\r\n\r\n    if (typeof alignX === \"undefined\") alignX = 0.5;\r\n    if (typeof alignY === \"undefined\") alignY = 0.5;\r\n    if (typeof rotation === \"undefined\") rotation = 0;\r\n    if (typeof scaleX === \"undefined\") scaleX = 1.0;\r\n    if (typeof scaleY === \"undefined\") scaleY = scaleX;\r\n\r\n    this.translate(x, y);\r\n    this.align(alignX, alignY);\r\n    this.rotate(rotation);\r\n    this.scale(scaleX, scaleY);\r\n\r\n    return this;\r\n\r\n  },\r\n\r\n  drawImage: function() {\r\n\r\n\r\n    if (this.alignX || this.alignY) {\r\n      if (arguments.length === 3) {\r\n        arguments[1] -= arguments[0].width * this.alignX | 0;\r\n        arguments[2] -= arguments[0].height * this.alignY | 0;\r\n      } else if (arguments.length === 9) {\r\n        arguments[5] -= arguments[7] * this.alignX | 0;\r\n        arguments[6] -= arguments[8] * this.alignY | 0;\r\n      }\r\n    }\r\n\r\n    fastApply(this.context.drawImage, this.context, arguments);\r\n\r\n    return this;\r\n\r\n  },\r\n\r\n  save: function() {\r\n    this.prevAlignX = this.alignX;\r\n    this.prevAlignY = this.alignY;\r\n\r\n    this.context.save();\r\n\r\n    return this;\r\n  },\r\n\r\n  restore: function() {\r\n\r\n    this.realign();\r\n    this.context.restore();\r\n    return this;\r\n  },\r\n\r\n  drawTile: function(image, x, y, frameX, frameY, frameWidth, frameHeight, frames, frame) {\r\n\r\n  },\r\n\r\n  drawAtlasFrame: function(atlas, frame, x, y) {\r\n\r\n    var frame = atlas.frames[frame];\r\n\r\n    this.drawRegion(\r\n      atlas.image,\r\n      frame.region,\r\n      x - frame.width * this.alignX + frame.offset[0] + frame.region[2] * this.alignX, y - frame.height * this.alignY + frame.offset[1] + frame.region[3] * this.alignY\r\n    );\r\n\r\n    return this;\r\n\r\n  },\r\n\r\n  drawRegion: function(image, region, x, y, scale) {\r\n    scale = scale || 1;\r\n\r\n    return this.drawImage(\r\n      image, region[0], region[1], region[2], region[3],\r\n      x | 0, y | 0, region[2] * scale | 0, region[3] * scale | 0\r\n    );\r\n  },\r\n\r\n  cache: function() {\r\n    return this.clone().canvas;\r\n\r\n    /* FFS .... image.src is no longer synchronous when assigning dataURL */\r\n\r\n    var image = new Image;\r\n    image.src = this.canvas.toDataURL();\r\n    return image;\r\n  },\r\n\r\n  blendOn: function(what, mode, mix) {\r\n    cq.blend(what, this, mode, mix);\r\n\r\n    return this;\r\n  },\r\n\r\n  posterize: function(pc, inc) {\r\n    pc = pc || 32;\r\n    inc = inc || 4;\r\n    var imgdata = this.getImageData(0, 0, this.width, this.height);\r\n    var data = imgdata.data;\r\n\r\n    for (var i = 0; i < data.length; i += inc) {\r\n      data[i] -= data[i] % pc; // set value to nearest of 8 possibilities\r\n      data[i + 1] -= data[i + 1] % pc; // set value to nearest of 8 possibilities\r\n      data[i + 2] -= data[i + 2] % pc; // set value to nearest of 8 possibilities\r\n    }\r\n\r\n    this.putImageData(imgdata, 0, 0); // put image data to canvas\r\n  },\r\n\r\n\r\n  bw: function(pc) {\r\n    pc = 128;\r\n    var imgdata = this.getImageData(0, 0, this.width, this.height);\r\n    var data = imgdata.data;\r\n    // 8-bit: rrr ggg bb\r\n    for (var i = 0; i < data.length; i += 4) {\r\n      var v = ((data[i] + data[i + 1] + data[i + 2]) / 3);\r\n\r\n      v = (v / 128 | 0) * 128;\r\n      //data[i] = v; // set value to nearest of 8 possibilities\r\n      //data[i + 1] = v; // set value to nearest of 8 possibilities\r\n      data[i + 2] = (v / 255) * data[i]; // set value to nearest of 8 possibilities\r\n\r\n    }\r\n\r\n    this.putImageData(imgdata, 0, 0); // put image data to canvas\r\n  },\r\n\r\n  blend: function(what, mode, mix) {\r\n    if (typeof what === \"string\") {\r\n      var color = what;\r\n      what = cq(this.canvas.width, this.canvas.height);\r\n      what.fillStyle(color).fillRect(0, 0, this.canvas.width, this.canvas.height);\r\n    }\r\n\r\n    var result = cq.blend(this, what, mode, mix);\r\n\r\n    this.canvas = result.canvas;\r\n    this.context = result.context;\r\n\r\n    return this;\r\n  },\r\n\r\n\r\n  textWithBackground: function(text, x, y, background, padding) {\r\n    var w = this.measureText(text).width;\r\n    var h = this.fontHeight() * 0.8;\r\n    var f = this.fillStyle();\r\n    var padding = padding || 2;\r\n\r\n    this.fillStyle(background).fillRect(x - w / 2 - padding * 2, y - padding, w + padding * 4, h + padding * 2)\r\n    this.fillStyle(f).textAlign(\"center\").textBaseline(\"top\").fillText(text, x, y);\r\n\r\n    return this;\r\n  },\r\n\r\n  fillCircle: function(x, y, r) {\r\n    this.context.beginPath();\r\n    this.context.arc(x, y, r, 0, Math.PI * 2);\r\n    this.context.fill();\r\n    return this;\r\n  },\r\n\r\n  strokeCircle: function(x, y, r) {\r\n    this.context.beginPath();\r\n    this.context.arc(x, y, r, 0, Math.PI * 2);\r\n    this.context.stroke();\r\n    return this;\r\n  },\r\n\r\n  circle: function(x, y, r) {\r\n    this.context.beginPath();\r\n    this.context.arc(x, y, r, 0, Math.PI * 2);\r\n    return this;\r\n  },\r\n\r\n  crop: function(x, y, w, h) {\r\n\r\n    if (arguments.length === 1) {\r\n\r\n      var y = arguments[0][1];\r\n      var w = arguments[0][2];\r\n      var h = arguments[0][3];\r\n      var x = arguments[0][0];\r\n    }\r\n\r\n    var canvas = cq.createCanvas(w, h);\r\n    var context = canvas.getContext(\"2d\");\r\n\r\n    context.drawImage(this.canvas, x, y, w, h, 0, 0, w, h);\r\n    this.canvas.width = w;\r\n    this.canvas.height = h;\r\n    this.clear();\r\n    this.context.drawImage(canvas, 0, 0);\r\n\r\n    return this;\r\n  },\r\n\r\n  set: function(properties) {\r\n    cq.extend(this.context, properties);\r\n  },\r\n\r\n  resize: function(width, height) {\r\n    var w = width,\r\n      h = height;\r\n\r\n    if (arguments.length === 1) {\r\n      w = arguments[0] * this.canvas.width | 0;\r\n      h = arguments[0] * this.canvas.height | 0;\r\n    } else {\r\n\r\n      if (height === false) {\r\n        if (this.canvas.width > width) {\r\n          h = this.canvas.height * (width / this.canvas.width) | 0;\r\n          w = width;\r\n        } else {\r\n          w = this.canvas.width;\r\n          h = this.canvas.height;\r\n        }\r\n      } else if (width === false) {\r\n        if (this.canvas.width > width) {\r\n          w = this.canvas.width * (height / this.canvas.height) | 0;\r\n          h = height;\r\n        } else {\r\n          w = this.canvas.width;\r\n          h = this.canvas.height;\r\n        }\r\n      }\r\n    }\r\n\r\n    var cqresized = cq(w, h).drawImage(this.canvas, 0, 0, this.canvas.width, this.canvas.height, 0, 0, w, h);\r\n    this.canvas = cqresized.canvas;\r\n    this.context = cqresized.context;\r\n\r\n    return this;\r\n  },\r\n\r\n  imageLine: function(image, region, x, y, ex, ey, scale) {\r\n    if (!region) region = [0, 0, image.width, image.height];\r\n\r\n    var distance = cq.distance(x, y, ex, ey);\r\n    var count = distance / region[3] + 0.5 | 0;\r\n    var angle = Math.atan2(ey - y, ex - x) + Math.PI / 2;\r\n\r\n    this.save();\r\n\r\n    this.translate(x, y);\r\n    this.rotate(angle);\r\n\r\n    if (scale) this.scale(scale, 1.0);\r\n\r\n    for (var i = 0; i <= count; i++) {\r\n      this.drawRegion(image, region, -region[2] / 2 | 0, -region[3] * (i + 1));\r\n    }\r\n\r\n    this.restore();\r\n\r\n    return this;\r\n  },\r\n\r\n  trim: function(color, changes) {\r\n    var transparent;\r\n\r\n    if (color) {\r\n      color = cq.color(color).toArray();\r\n      transparent = !color[3];\r\n    } else transparent = true;\r\n\r\n    var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var sourcePixels = sourceData.data;\r\n\r\n    var bound = [this.canvas.width, this.canvas.height, 0, 0];\r\n\r\n    var width = this.canvas.width;\r\n    var height = this.canvas.height;\r\n\r\n    for (var i = 0, len = sourcePixels.length; i < len; i += 4) {\r\n      if (transparent) {\r\n        if (!sourcePixels[i + 3]) continue;\r\n      } else if (sourcePixels[i + 0] === color[0] && sourcePixels[i + 1] === color[1] && sourcePixels[i + 2] === color[2]) continue;\r\n\r\n      var x = (i / 4 | 0) % this.canvas.width | 0;\r\n      var y = (i / 4 | 0) / this.canvas.width | 0;\r\n\r\n      if (x < bound[0]) bound[0] = x;\r\n      if (x > bound[2]) bound[2] = x;\r\n\r\n      if (y < bound[1]) bound[1] = y;\r\n      if (y > bound[3]) bound[3] = y;\r\n    }\r\n\r\n\r\n    if (bound[2] === 0 && bound[3] === 0) {} else {\r\n      if (changes) {\r\n        changes.left = bound[0];\r\n        changes.top = bound[1];\r\n\r\n        changes.bottom = height - bound[3];\r\n        changes.right = width - bound[2] - bound[0];\r\n\r\n        changes.width = bound[2] - bound[0];\r\n        changes.height = bound[3] - bound[1];\r\n      }\r\n\r\n      this.crop(bound[0], bound[1], bound[2] - bound[0] + 1, bound[3] - bound[1] + 1);\r\n    }\r\n\r\n    return this;\r\n  },\r\n\r\n  matchPalette: function(palette) {\r\n    var imgData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n\r\n    var rgbPalette = [];\r\n\r\n    for (var i = 0; i < palette.length; i++) {\r\n      rgbPalette.push(cq.color(palette[i]));\r\n    }\r\n\r\n\r\n    for (var i = 0; i < imgData.data.length; i += 4) {\r\n      var difList = [];\r\n      if (!imgData.data[i + 3]) continue;\r\n\r\n      for (var j = 0; j < rgbPalette.length; j++) {\r\n        var rgbVal = rgbPalette[j];\r\n        var rDif = Math.abs(imgData.data[i] - rgbVal[0]),\r\n          gDif = Math.abs(imgData.data[i + 1] - rgbVal[1]),\r\n          bDif = Math.abs(imgData.data[i + 2] - rgbVal[2]);\r\n        difList.push(rDif + gDif + bDif);\r\n      }\r\n\r\n      var closestMatch = 0;\r\n\r\n      for (var j = 0; j < palette.length; j++) {\r\n        if (difList[j] < difList[closestMatch]) {\r\n          closestMatch = j;\r\n        }\r\n      }\r\n\r\n      var paletteRgb = cq.hexToRgb(palette[closestMatch]);\r\n      imgData.data[i] = paletteRgb[0];\r\n      imgData.data[i + 1] = paletteRgb[1];\r\n      imgData.data[i + 2] = paletteRgb[2];\r\n\r\n      /* dithering */\r\n      //imgData.data[i + 3] = (255 * Math.random() < imgData.data[i + 3]) ? 255 : 0;\r\n\r\n      //imgData.data[i + 3] = imgData.data[i + 3] > 128 ? 255 : 0;\r\n      /*\r\n      if (i % 3 === 0) {\r\n        imgData.data[i] -= cq.limitValue(imgData.data[i] - 50, 0, 255);\r\n        imgData.data[i + 1] -= cq.limitValue(imgData.data[i + 1] - 50, 0, 255);\r\n        imgData.data[i + 2] -= cq.limitValue(imgData.data[i + 2] - 50, 0, 255);\r\n      }\r\n      */\r\n\r\n    }\r\n\r\n    this.context.putImageData(imgData, 0, 0);\r\n\r\n    return this;\r\n  },\r\n\r\n  getPalette: function() {\r\n    var palette = [];\r\n    var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var sourcePixels = sourceData.data;\r\n\r\n    for (var i = 0, len = sourcePixels.length; i < len; i += 4) {\r\n      if (sourcePixels[i + 3]) {\r\n        var hex = cq.rgbToHex(sourcePixels[i + 0], sourcePixels[i + 1], sourcePixels[i + 2]);\r\n        if (palette.indexOf(hex) === -1) palette.push(hex);\r\n      }\r\n    }\r\n\r\n    return palette;\r\n  },\r\n\r\n  mapPalette: function() {\r\n\r\n  },\r\n\r\n  polygon: function(array) {\r\n\r\n    this.beginPath();\r\n\r\n    this.moveTo(array[0][0], array[0][1]);\r\n\r\n    for (var i = 1; i < array.length; i++) {\r\n      this.lineTo(array[i][0], array[i][1]);\r\n    }\r\n\r\n    this.closePath();\r\n\r\n    return this;\r\n  },\r\n\r\n  fillPolygon: function(polygon) {\r\n    this.beginPath();\r\n    this.polygon(polygon);\r\n    this.fill();\r\n  },\r\n\r\n  strokePolygon: function(polygon) {\r\n    this.beginPath();\r\n    this.polygon(polygon);\r\n    this.stroke();\r\n  },\r\n\r\n  colorToMask: function(color, inverted) {\r\n    color = cq.color(color).toArray();\r\n    var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var sourcePixels = sourceData.data;\r\n\r\n    var mask = [];\r\n\r\n    for (var i = 0, len = sourcePixels.length; i < len; i += 4) {\r\n      if (sourcePixels[i + 3] > 0) mask.push(inverted ? false : true);\r\n      else mask.push(inverted ? true : false);\r\n    }\r\n\r\n    return mask;\r\n  },\r\n\r\n  grayscaleToMask: function() {\r\n\r\n    var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var sourcePixels = sourceData.data;\r\n\r\n    var mask = [];\r\n\r\n    for (var i = 0, len = sourcePixels.length; i < len; i += 4) {\r\n      mask.push(((sourcePixels[i + 0] + sourcePixels[i + 1] + sourcePixels[i + 2]) / 3) / 255);\r\n    }\r\n\r\n    return mask;\r\n  },\r\n\r\n  applyMask: function(mask) {\r\n    var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var sourcePixels = sourceData.data;\r\n\r\n    var mode = typeof mask[0] === \"boolean\" ? \"bool\" : \"byte\";\r\n\r\n    for (var i = 0, len = sourcePixels.length; i < len; i += 4) {\r\n      var value = mask[i / 4];\r\n      sourcePixels[i + 3] = value * 255 | 0;\r\n    }\r\n\r\n    this.context.putImageData(sourceData, 0, 0);\r\n    return this;\r\n  },\r\n\r\n  fillMask: function(mask) {\r\n\r\n    var sourceData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var sourcePixels = sourceData.data;\r\n\r\n    var maskType = typeof mask[0] === \"boolean\" ? \"bool\" : \"byte\";\r\n    var colorMode = arguments.length === 2 ? \"normal\" : \"gradient\";\r\n\r\n    var color = cq.color(arguments[1]);\r\n    if (colorMode === \"gradient\") colorB = cq.color(arguments[2]);\r\n\r\n    for (var i = 0, len = sourcePixels.length; i < len; i += 4) {\r\n      var value = mask[i / 4];\r\n\r\n      if (maskType === \"byte\") value /= 255;\r\n\r\n      if (colorMode === \"normal\") {\r\n        if (value) {\r\n          sourcePixels[i + 0] = color[0] | 0;\r\n          sourcePixels[i + 1] = color[1] | 0;\r\n          sourcePixels[i + 2] = color[2] | 0;\r\n          sourcePixels[i + 3] = value * 255 | 0;\r\n        }\r\n      } else {\r\n        sourcePixels[i + 0] = color[0] + (colorB[0] - color[0]) * value | 0;\r\n        sourcePixels[i + 1] = color[1] + (colorB[1] - color[1]) * value | 0;\r\n        sourcePixels[i + 2] = color[2] + (colorB[2] - color[2]) * value | 0;\r\n        sourcePixels[i + 3] = 255;\r\n      }\r\n    }\r\n\r\n    this.context.putImageData(sourceData, 0, 0);\r\n    return this;\r\n  },\r\n\r\n  clear: function(color) {\r\n    if (color) {\r\n      this.context.fillStyle = color;\r\n      this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);\r\n    } else {\r\n      this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n    }\r\n\r\n    return this;\r\n  },\r\n\r\n  clone: function() {\r\n\r\n    // var result = cq.createCanvas(this.canvas);\r\n\r\n    var result = cq.pool();\r\n    result.width = this.width;\r\n    result.height = this.height;\r\n    result.getContext(\"2d\").drawImage(this.canvas, 0, 0);\r\n\r\n    return cq(result);\r\n  },\r\n\r\n  gradientText: function(text, x, y, maxWidth, gradient) {\r\n\r\n    var words = text.split(\" \");\r\n\r\n    var h = this.fontHeight() * 2;\r\n\r\n    var ox = 0;\r\n    var oy = 0;\r\n\r\n    if (maxWidth) {\r\n      var line = 0;\r\n      var lines = [\"\"];\r\n\r\n      for (var i = 0; i < words.length; i++) {\r\n        var word = words[i] + \" \";\r\n        var wordWidth = this.context.measureText(word).width;\r\n\r\n        if (ox + wordWidth > maxWidth) {\r\n          lines[++line] = \"\";\r\n          ox = 0;\r\n        }\r\n\r\n        lines[line] += word;\r\n\r\n        ox += wordWidth;\r\n      }\r\n    } else var lines = [text];\r\n\r\n    for (var i = 0; i < lines.length; i++) {\r\n      var oy = y + i * h * 0.6 | 0;\r\n      var lingrad = this.context.createLinearGradient(0, oy, 0, oy + h * 0.6 | 0);\r\n\r\n      for (var j = 0; j < gradient.length; j += 2) {\r\n        lingrad.addColorStop(gradient[j], gradient[j + 1]);\r\n      }\r\n\r\n      var text = lines[i];\r\n\r\n      this.fillStyle(lingrad).fillText(text, x, oy);\r\n    }\r\n\r\n    return this;\r\n  },\r\n\r\n  removeColor: function(color) {\r\n\r\n    color = cq.color(color);\r\n\r\n    var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var pixels = data.data;\r\n\r\n    for (var x = 0; x < this.canvas.width; x++) {\r\n      for (var y = 0; y < this.canvas.height; y++) {\r\n        var i = (y * this.canvas.width + x) * 4;\r\n\r\n        if (pixels[i + 0] === color[0] && pixels[i + 1] === color[1] && pixels[i + 2] === color[2]) {\r\n          pixels[i + 3] = 0;\r\n        }\r\n\r\n\r\n      }\r\n    }\r\n\r\n    this.clear();\r\n    this.context.putImageData(data, 0, 0);\r\n\r\n    return this;\r\n  },\r\n\r\n  outline: function() {\r\n    var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var pixels = data.data;\r\n\r\n    var newData = this.createImageData(this.canvas.width, this.canvas.height);\r\n    var newPixels = newData.data;\r\n\r\n    var canvas = this.canvas;\r\n\r\n    function check(x, y) {\r\n\r\n      if (x < 0) return 0;\r\n      if (x >= canvas.width) return 0;\r\n      if (y < 0) return 0;\r\n      if (y >= canvas.height) return 0;\r\n\r\n      var i = (x + y * canvas.width) * 4;\r\n\r\n      return pixels[i + 3] > 0;\r\n\r\n    }\r\n\r\n    for (var x = 0; x < this.canvas.width; x++) {\r\n      for (var y = 0; y < this.canvas.height; y++) {\r\n\r\n        var full = 0;\r\n        var i = (y * canvas.width + x) * 4;\r\n\r\n        if (!pixels[i + 3]) continue;\r\n\r\n        full += check(x - 1, y);\r\n        full += check(x + 1, y);\r\n        full += check(x, y - 1);\r\n        full += check(x, y + 1);\r\n\r\n        if (full !== 4) {\r\n\r\n          newPixels[i] = 255;\r\n          newPixels[i + 1] = 255;\r\n          newPixels[i + 2] = 255;\r\n          newPixels[i + 3] = 255;\r\n        }\r\n\r\n      }\r\n    }\r\n\r\n    this.context.putImageData(newData, 0, 0);\r\n\r\n    return this;\r\n  },\r\n\r\n  setHsl: function() {\r\n\r\n    if (arguments.length === 1) {\r\n      var args = arguments[0];\r\n    } else {\r\n      var args = arguments;\r\n    }\r\n\r\n    var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var pixels = data.data;\r\n    var r, g, b, a, h, s, l, hsl = [],\r\n      newPixel = [];\r\n\r\n    for (var i = 0, len = pixels.length; i < len; i += 4) {\r\n      hsl = cq.rgbToHsl(pixels[i + 0], pixels[i + 1], pixels[i + 2]);\r\n\r\n      h = args[0] === false ? hsl[0] : cq.limitValue(args[0], 0, 1);\r\n      s = args[1] === false ? hsl[1] : cq.limitValue(args[1], 0, 1);\r\n      l = args[2] === false ? hsl[2] : cq.limitValue(args[2], 0, 1);\r\n\r\n      newPixel = cq.hslToRgb(h, s, l);\r\n\r\n      pixels[i + 0] = newPixel[0];\r\n      pixels[i + 1] = newPixel[1];\r\n      pixels[i + 2] = newPixel[2];\r\n    }\r\n\r\n    this.context.putImageData(data, 0, 0);\r\n\r\n    return this;\r\n  },\r\n\r\n  shiftHsl: function() {\r\n\r\n    if (arguments.length === 1) {\r\n      var args = arguments[0];\r\n    } else {\r\n      var args = arguments;\r\n    }\r\n\r\n    var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var pixels = data.data;\r\n    var r, g, b, a, h, s, l, hsl = [],\r\n      newPixel = [];\r\n\r\n    for (var i = 0, len = pixels.length; i < len; i += 4) {\r\n      hsl = cq.rgbToHsl(pixels[i + 0], pixels[i + 1], pixels[i + 2]);\r\n\r\n      if (pixels[i + 0] !== pixels[i + 1] || pixels[i + 1] !== pixels[i + 2]) {\r\n        h = args[0] === false ? hsl[0] : cq.wrapValue(hsl[0] + args[0], 0, 1);\r\n        s = args[1] === false ? hsl[1] : cq.limitValue(hsl[1] + args[1], 0, 1);\r\n      } else {\r\n        h = hsl[0];\r\n        s = hsl[1];\r\n      }\r\n\r\n      l = args[2] === false ? hsl[2] : cq.limitValue(hsl[2] + args[2], 0, 1);\r\n\r\n      newPixel = cq.hslToRgb(h, s, l);\r\n\r\n      pixels[i + 0] = newPixel[0];\r\n      pixels[i + 1] = newPixel[1];\r\n      pixels[i + 2] = newPixel[2];\r\n    }\r\n\r\n\r\n    this.context.putImageData(data, 0, 0);\r\n\r\n    return this;\r\n  },\r\n\r\n  applyColor: function(color) {\r\n\r\n    if (COCOONJS) return this;\r\n    this.save();\r\n\r\n    this.globalCompositeOperation(\"source-in\");\r\n    this.clear(color);\r\n\r\n    this.restore();\r\n\r\n    return this;\r\n  },\r\n\r\n  negative: function(src, dst) {\r\n\r\n    var data = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);\r\n    var pixels = data.data;\r\n    var r, g, b, a, h, s, l, hsl = [],\r\n      newPixel = [];\r\n\r\n    for (var i = 0, len = pixels.length; i < len; i += 4) {\r\n      pixels[i + 0] = 255 - pixels[i + 0];\r\n      pixels[i + 1] = 255 - pixels[i + 1];\r\n      pixels[i + 2] = 255 - pixels[i + 2];\r\n    }\r\n\r\n    this.context.putImageData(data, 0, 0);\r\n\r\n    return this;\r\n  },\r\n\r\n  roundRect: function(x, y, width, height, radius) {\r\n\r\n    this.beginPath();\r\n    this.moveTo(x + radius, y);\r\n    this.lineTo(x + width - radius, y);\r\n    this.quadraticCurveTo(x + width, y, x + width, y + radius);\r\n    this.lineTo(x + width, y + height - radius);\r\n    this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);\r\n    this.lineTo(x + radius, y + height);\r\n    this.quadraticCurveTo(x, y + height, x, y + height - radius);\r\n    this.lineTo(x, y + radius);\r\n    this.quadraticCurveTo(x, y, x + radius, y);\r\n    this.closePath();\r\n\r\n    return this;\r\n  },\r\n\r\n  markupText: function(text) {\r\n\r\n\r\n  },\r\n\r\n  wrappedText: function(text, x, y, maxWidth, lineHeight) {\r\n\r\n    var words = text.split(\" \");\r\n\r\n    var lineHeight = lineHeight || this.fontHeight();\r\n\r\n    var ox = 0;\r\n    var oy = 0;\r\n\r\n    if (maxWidth) {\r\n      var line = 0;\r\n      var lines = [\"\"];\r\n\r\n      for (var i = 0; i < words.length; i++) {\r\n        var word = words[i] + \" \";\r\n        var wordWidth = this.context.measureText(word).width;\r\n\r\n        if (ox + wordWidth > maxWidth || words[i] === \"\\n\") {\r\n          lines[++line] = \"\";\r\n          ox = 0;\r\n        }\r\n        if (words[i] !== \"\\n\") {\r\n          lines[line] += word;\r\n\r\n          ox += wordWidth;\r\n        }\r\n\r\n\r\n      }\r\n    } else {\r\n      var lines = [text];\r\n    }\r\n\r\n    for (var i = 0; i < lines.length; i++) {\r\n      var oy = y + i * lineHeight | 0;\r\n\r\n      var text = lines[i];\r\n\r\n      this.fillText(text, x, oy);\r\n    }\r\n\r\n    return this;\r\n  },\r\n\r\n  fontHeights: {},\r\n\r\n  fontHeight: function() {\r\n    var font = this.font();\r\n\r\n    if (!this.fontHeights[font]) {\r\n      var temp = cq(100, 100);\r\n      var height = 0;\r\n      var changes = {};\r\n      temp.font(font).fillStyle(\"#fff\");\r\n      temp.textBaseline(\"bottom\").fillText(\"gM\", 25, 100);\r\n      temp.trim(false, changes);\r\n      height += changes.bottom;\r\n\r\n      var temp = cq(100, 100);\r\n      var changes = {};\r\n      temp.font(font).fillStyle(\"#fff\");\r\n      temp.textBaseline(\"top\").fillText(\"gM\", 25, 0);\r\n      temp.trim(false, changes);\r\n      height += changes.top;\r\n\r\n      var temp = cq(100, 100);\r\n      var changes = {};\r\n      temp.font(font).fillStyle(\"#fff\");\r\n      temp.textBaseline(\"alphabetic\").fillText(\"gM\", 50, 50);\r\n      temp.trim(false, changes);\r\n      height += temp.height;\r\n\r\n      this.fontHeights[font] = height;\r\n    }\r\n\r\n    return this.fontHeights[font];\r\n  },\r\n\r\n  textBoundaries: function(text, maxWidth) {\r\n    var words = text.split(\" \");\r\n\r\n    var h = this.fontHeight();\r\n\r\n    var ox = 0;\r\n    var oy = 0;\r\n\r\n    if (maxWidth) {\r\n      var line = 0;\r\n      var lines = [\"\"];\r\n\r\n      for (var i = 0; i < words.length; i++) {\r\n        var word = words[i] + \" \";\r\n        var wordWidth = this.context.measureText(word).width;\r\n\r\n        if (ox + wordWidth > maxWidth || words[i] === \"\\n\") {\r\n          lines[++line] = \"\";\r\n          ox = 0;\r\n        }\r\n\r\n        if (words[i] !== \"\\n\") {\r\n          lines[line] += word;\r\n          ox += wordWidth;\r\n        }\r\n      }\r\n    } else {\r\n      var lines = [text];\r\n      maxWidth = this.measureText(text).width;\r\n    }\r\n\r\n    return {\r\n      height: lines.length * h,\r\n      width: maxWidth,\r\n      lines: lines.length,\r\n      lineHeight: h\r\n    }\r\n  },\r\n\r\n  repeatImageRegion: function(image, sx, sy, sw, sh, dx, dy, dw, dh) {\r\n    this.save();\r\n    this.rect(dx, dy, dw, dh);\r\n    this.clip();\r\n\r\n    for (var x = 0, len = Math.ceil(dw / sw); x < len; x++) {\r\n      for (var y = 0, leny = Math.ceil(dh / sh); y < leny; y++) {\r\n        this.drawImage(image, sx, sy, sw, sh, dx + x * sw, dy + y * sh, sw, sh);\r\n      }\r\n    }\r\n\r\n    this.restore();\r\n\r\n    return this;\r\n  },\r\n\r\n  repeatImage: function(image, x, y, w, h) {\r\n    // if (!env.details) return this;\r\n\r\n    if (arguments.length < 9) {\r\n      this.repeatImageRegion(image, 0, 0, image.width, image.height, x, y, w, h);\r\n    } else {\r\n      this.repeatImageRegion.apply(this, arguments);\r\n    }\r\n\r\n    return this;\r\n  },\r\n\r\n  borderImage: function(image, x, y, w, h, t, r, b, l, fill) {\r\n\r\n    // if (!env.details) return this;\r\n\r\n    if (typeof t === \"object\") {\r\n\r\n      var bottomLeft = t.bottomLeft || [0, 0, 0, 0];\r\n      var bottomRight = t.bottomRight || [0, 0, 0, 0];\r\n      var topLeft = t.topLeft || [0, 0, 0, 0];\r\n      var topRight = t.topRight || [0, 0, 0, 0];\r\n\r\n      var clh = bottomLeft[3] + topLeft[3];\r\n      var crh = bottomRight[3] + topRight[3];\r\n      var ctw = topLeft[2] + topRight[2];\r\n      var cbw = bottomLeft[2] + bottomRight[2];\r\n\r\n      t.fillPadding = [0, 0, 0, 0];\r\n\r\n      if (t.left) t.fillPadding[0] = t.left[2];\r\n      if (t.top) t.fillPadding[1] = t.top[3];\r\n      if (t.right) t.fillPadding[2] = t.right[2];\r\n      if (t.bottom) t.fillPadding[3] = t.bottom[3];\r\n\r\n      // if (!t.fillPadding) t.fillPadding = [0, 0, 0, 0];\r\n\r\n      if (t.fill) {\r\n        this.drawImage(image, t.fill[0], t.fill[1], t.fill[2], t.fill[3], x + t.fillPadding[0], y + t.fillPadding[1], w - t.fillPadding[2] - t.fillPadding[0], h - t.fillPadding[3] - t.fillPadding[1]);\r\n      } else {\r\n        // this.fillRect(x + t.fillPadding[0], y + t.fillPadding[1], w - t.fillPadding[2] - t.fillPadding[0], h - t.fillPadding[3] - t.fillPadding[1]);\r\n      }\r\n\r\n      if (t.left) this[t.left[4] === \"stretch\" ? \"drawImage\" : \"repeatImage\"](image, t.left[0], t.left[1], t.left[2], t.left[3], x, y + topLeft[3], t.left[2], h - clh);\r\n      if (t.right) this[t.right[4] === \"stretch\" ? \"drawImage\" : \"repeatImage\"](image, t.right[0], t.right[1], t.right[2], t.right[3], x + w - t.right[2], y + topRight[3], t.right[2], h - crh);\r\n      if (t.top) this[t.top[4] === \"stretch\" ? \"drawImage\" : \"repeatImage\"](image, t.top[0], t.top[1], t.top[2], t.top[3], x + topLeft[2], y, w - ctw, t.top[3]);\r\n      if (t.bottom) this[t.bottom[4] === \"stretch\" ? \"drawImage\" : \"repeatImage\"](image, t.bottom[0], t.bottom[1], t.bottom[2], t.bottom[3], x + bottomLeft[2], y + h - t.bottom[3], w - cbw, t.bottom[3]);\r\n\r\n      if (t.bottomLeft) this.drawImage(image, t.bottomLeft[0], t.bottomLeft[1], t.bottomLeft[2], t.bottomLeft[3], x, y + h - t.bottomLeft[3], t.bottomLeft[2], t.bottomLeft[3]);\r\n      if (t.topLeft) this.drawImage(image, t.topLeft[0], t.topLeft[1], t.topLeft[2], t.topLeft[3], x, y, t.topLeft[2], t.topLeft[3]);\r\n      if (t.topRight) this.drawImage(image, t.topRight[0], t.topRight[1], t.topRight[2], t.topRight[3], x + w - t.topRight[2], y, t.topRight[2], t.topRight[3]);\r\n      if (t.bottomRight) this.drawImage(image, t.bottomRight[0], t.bottomRight[1], t.bottomRight[2], t.bottomRight[3], x + w - t.bottomRight[2], y + h - t.bottomRight[3], t.bottomRight[2], t.bottomRight[3]);\r\n\r\n\r\n    } else {\r\n\r\n\r\n      /* top */\r\n      if (t > 0 && w - l - r > 0) this.drawImage(image, l, 0, image.width - l - r, t, x + l, y, w - l - r, t);\r\n\r\n      /* bottom */\r\n      if (b > 0 && w - l - r > 0) this.drawImage(image, l, image.height - b, image.width - l - r, b, x + l, y + h - b, w - l - r, b);\r\n      //      console.log(x, y, w, h, t, r, b, l);\r\n      //      console.log(image, 0, t, l, image.height - b - t, x, y + t, l, h - b - t);\r\n      /* left */\r\n      if (l > 0 && h - b - t > 0) this.drawImage(image, 0, t, l, image.height - b - t, x, y + t, l, h - b - t);\r\n\r\n\r\n      /* right */\r\n      if (r > 0 && h - b - t > 0) this.drawImage(image, image.width - r, t, r, image.height - b - t, x + w - r, y + t, r, h - b - t);\r\n\r\n      /* top-left */\r\n      if (l > 0 && t > 0) this.drawImage(image, 0, 0, l, t, x, y, l, t);\r\n\r\n      /* top-right */\r\n      if (r > 0 && t > 0) this.drawImage(image, image.width - r, 0, r, t, x + w - r, y, r, t);\r\n\r\n      /* bottom-right */\r\n      if (r > 0 && b > 0) this.drawImage(image, image.width - r, image.height - b, r, b, x + w - r, y + h - b, r, b);\r\n\r\n      /* bottom-left */\r\n      if (l > 0 && b > 0) this.drawImage(image, 0, image.height - b, l, b, x, y + h - b, l, b);\r\n\r\n      if (fill) {\r\n        if (typeof fill === \"string\") {\r\n          this.fillStyle(fill).fillRect(x + l, y + t, w - l - r, h - t - b);\r\n        } else {\r\n          if (w - l - r > 0 && h - t - b > 0)\r\n            this.drawImage(image, l, t, image.width - r - l, image.height - b - t, x + l, y + t, w - l - r, h - t - b);\r\n        }\r\n      }\r\n    }\r\n  },\r\n\r\n  setPixel: function(color, x, y) {\r\n\r\n    /* fillRect is slow! */\r\n\r\n    return this.fillStyle(color).fillRect(x, y, 1, 1);\r\n\r\n    /* this is how it should work - but it does not */\r\n\r\n    color = cq.color(color);\r\n\r\n    var pixel = this.createImageData(1, 1);\r\n\r\n    pixel.data[0] = color[0];\r\n    pixel.data[1] = color[1];\r\n    pixel.data[2] = color[2];\r\n    pixel.data[3] = 1.0;\r\n\r\n    this.putImageData(pixel, x, y);\r\n\r\n    return this;\r\n  },\r\n\r\n  getPixel: function(x, y) {\r\n    var pixel = this.context.getImageData(x, y, 1, 1).data;\r\n    return cq.color([pixel[0], pixel[1], pixel[2], pixel[3]]);\r\n  },\r\n\r\n  createImageData: function(width, height) {\r\n    if (false && this.context.createImageData) {\r\n      return this.context.createImageData.apply(this.context, arguments);\r\n    } else {\r\n      if (!this.emptyCanvas) {\r\n        this.emptyCanvas = cq.createCanvas(width, height);\r\n        this.emptyCanvasContext = this.emptyCanvas.getContext(\"2d\");\r\n      }\r\n\r\n      this.emptyCanvas.width = width;\r\n      this.emptyCanvas.height = height;\r\n      return this.emptyCanvasContext.getImageData(0, 0, width, height);\r\n    }\r\n  },\r\n\r\n  strokeLine: function(x1, y1, x2, y2) {\r\n\r\n    this.beginPath();\r\n\r\n    if (typeof x2 === \"undefined\") {\r\n      this.moveTo(x1.x, x1.y);\r\n      this.lineTo(y1.x, y1.y);\r\n    } else {\r\n      this.moveTo(x1, y1);\r\n      this.lineTo(x2, y2);\r\n    }\r\n\r\n    this.stroke();\r\n\r\n    return this;\r\n\r\n  },\r\n\r\n  setLineDash: function(dash) {\r\n    if (this.context.setLineDash) {\r\n      this.context.setLineDash(dash);\r\n      return this;\r\n    } else return this;\r\n  },\r\n\r\n  measureText: function() {\r\n    return this.context.measureText.apply(this.context, arguments);\r\n  },\r\n\r\n  getLineDash: function() {\r\n    return this.context.getLineDash();\r\n  },\r\n\r\n  createRadialGradient: function() {\r\n    return this.context.createRadialGradient.apply(this.context, arguments);\r\n  },\r\n\r\n  createLinearGradient: function() {\r\n    return this.context.createLinearGradient.apply(this.context, arguments);\r\n  },\r\n\r\n  createPattern: function() {\r\n    return this.context.createPattern.apply(this.context, arguments);\r\n  },\r\n\r\n  getImageData: function() {\r\n    return this.context.getImageData.apply(this.context, arguments);\r\n  },\r\n\r\n  /* If you think that I am retarded because I use fillRect to set\r\n     pixels - read about premultipled alpha in canvas */\r\n\r\n  writeMeta: function(data) {\r\n\r\n    var json = JSON.stringify(data);\r\n\r\n    json = encodeURIComponent(json);\r\n\r\n    var bytes = [];\r\n\r\n    for (var i = 0; i < json.length; i++) {\r\n      bytes.push(json.charCodeAt(i));\r\n      //      console.log(json[i])\r\n    }\r\n\r\n    bytes.push(127);\r\n\r\n    var x = this.width - 1;\r\n    var y = this.height - 1;\r\n\r\n    var pixel = [];\r\n\r\n    while (bytes.length) {\r\n\r\n      var byte = bytes.shift();\r\n\r\n      pixel.unshift(byte * 2);\r\n      //        console.log(x + String.fromCharCode(byte), byte);\r\n\r\n      if (!bytes.length)\r\n        for (var i = 0; i < 3 - pixel.length; i++) pixel.unshift(254);\r\n\r\n      if (pixel.length === 3) {\r\n        this.fillStyle(cq.color(pixel).toRgb()).fillRect(x, y, 1, 1);\r\n        pixel = [];\r\n        x--;\r\n\r\n        if (x < 0) {\r\n          y--;\r\n          x = this.width - 1;\r\n        }\r\n      }\r\n    }\r\n\r\n    return this;\r\n\r\n  },\r\n\r\n  readMeta: function() {\r\n\r\n    var bytes = [];\r\n\r\n    var x = this.width - 1;\r\n    var y = this.height - 1;\r\n\r\n    while (true) {\r\n      var pixel = this.getPixel(x, y);\r\n\r\n      var stop = false;\r\n\r\n      for (var i = 0; i < 3; i++) {\r\n\r\n        if (pixel[2 - i] === 254) stop = true;\r\n\r\n        else bytes.push(pixel[2 - i] / 2 | 0);\r\n\r\n      }\r\n\r\n      if (stop) break;\r\n\r\n      x--;\r\n\r\n      if (x < 0) {\r\n        y--;\r\n        x = this.width - 1;\r\n        break;\r\n      }\r\n    }\r\n\r\n\r\n    var json = \"\";\r\n\r\n    while (bytes.length) {\r\n      json += String.fromCharCode(bytes.shift());\r\n    }\r\n\r\n    var data = false;\r\n\r\n    console.log(json);\r\n\r\n    try {\r\n      data = JSON.parse(decodeURIComponent(json));\r\n    } catch (e) {\r\n\r\n    }\r\n\r\n    return data;\r\n\r\n  },\r\n\r\n  get width() {\r\n    return this.canvas.width;\r\n  },\r\n\r\n  get height() {\r\n    return this.canvas.height;\r\n  },\r\n\r\n  set width(w) {\r\n    this.canvas.width = w;\r\n    this.update();\r\n    return this.canvas.width;\r\n  },\r\n\r\n  set height(h) {\r\n    this.canvas.height = h;\r\n    this.update();\r\n    return this.canvas.height;\r\n  }\r\n\r\n\r\n};\r\n\r\n/* extend Layer with drawing context methods */\r\n\r\nvar methods = [\"arc\", \"arcTo\", \"beginPath\", \"bezierCurveTo\", \"clearRect\", \"clip\", \"closePath\", \"createLinearGradient\", \"createRadialGradient\", \"createPattern\", \"drawFocusRing\", \"drawImage\", \"fill\", \"fillRect\", \"fillText\", \"getImageData\", \"isPointInPath\", \"lineTo\", \"measureText\", \"moveTo\", \"putImageData\", \"quadraticCurveTo\", \"rect\", \"restore\", \"rotate\", \"save\", \"scale\", \"setTransform\", \"stroke\", \"strokeRect\", \"strokeText\", \"transform\", \"translate\", \"setLineDash\"];\r\n\r\nfor (var i = 0; i < methods.length; i++) {\r\n  var name = methods[i];\r\n\r\n  if (cq.Layer.prototype[name]) continue;\r\n\r\n  cq.Layer.prototype[name] = (function(method) {\r\n\r\n    return function() {\r\n      fastApply(method, this.context, arguments);\r\n      return this;\r\n    }\r\n\r\n  })(CanvasRenderingContext2D.prototype[name]);\r\n\r\n\r\n  continue;\r\n\r\n\r\n  if (!this.debug) {\r\n    // if (!cq.Layer.prototype[name]) cq.Layer.prototype[name] = Function(\"this.context.\" + name + \".apply(this.context, arguments); return this;\");\r\n\r\n    var self = this;\r\n\r\n    (function(name) {\r\n\r\n      cq.Layer.prototype[name] = function() {\r\n        // this.context[name].apply(this.context, arguments);\r\n\r\n        fastApply(this.context[name], this.context, arguments);\r\n\r\n        return this;\r\n      }\r\n\r\n    })(name);\r\n\r\n  } else {\r\n\r\n    var self = this;\r\n\r\n    (function(name) {\r\n\r\n      cq.Layer.prototype[name] = function() {\r\n        try {\r\n          this.context[name].apply(this.context, arguments);\r\n          return this;\r\n        } catch (e) {\r\n          var err = new Error();\r\n          console.log(err.stack);\r\n          throw (e + err.stack);\r\n\r\n          console.log(e, name, arguments);\r\n        }\r\n      }\r\n\r\n    })(name);\r\n\r\n  }\r\n\r\n};\r\n\r\n/* create setters and getters */\r\n\r\nvar properties = [\"canvas\", \"fillStyle\", \"font\", \"globalAlpha\", \"globalCompositeOperation\", \"lineCap\", \"lineJoin\", \"lineWidth\", \"miterLimit\", \"shadowOffsetX\", \"shadowOffsetY\", \"shadowBlur\", \"shadowColor\", \"strokeStyle\", \"textAlign\", \"textBaseline\", \"lineDashOffset\"];\r\n\r\nfor (var i = 0; i < properties.length; i++) {\r\n  var name = properties[i];\r\n  if (!cq.Layer.prototype[name]) cq.Layer.prototype[name] = Function(\"if(arguments.length) { this.context.\" + name + \" = arguments[0]; return this; } else { return this.context.\" + name + \"; }\");\r\n};\r\n\r\n/* color */\r\n\r\ncq.Color = function(data, type) {\r\n\r\n  if (arguments.length) this.parse(data, type);\r\n}\r\n\r\ncq.Color.prototype = {\r\n\r\n  toString: function() {\r\n    return this.toRgb();\r\n  },\r\n\r\n  parse: function(args, type) {\r\n    if (args[0] instanceof cq.Color) {\r\n      this[0] = args[0][0];\r\n      this[1] = args[0][1];\r\n      this[2] = args[0][2];\r\n      this[3] = args[0][3];\r\n      return;\r\n    }\r\n\r\n    if (typeof args === \"string\") {\r\n      var match = null;\r\n\r\n      if (args[0] === \"#\") {\r\n        var rgb = cq.hexToRgb(args);\r\n        this[0] = rgb[0];\r\n        this[1] = rgb[1];\r\n        this[2] = rgb[2];\r\n        this[3] = 1.0;\r\n      } else if (match = args.match(/rgb\\((.*),(.*),(.*)\\)/)) {\r\n        this[0] = match[1] | 0;\r\n        this[1] = match[2] | 0;\r\n        this[2] = match[3] | 0;\r\n        this[3] = 1.0;\r\n      } else if (match = args.match(/rgba\\((.*),(.*),(.*)\\)/)) {\r\n        this[0] = match[1] | 0;\r\n        this[1] = match[2] | 0;\r\n        this[2] = match[3] | 0;\r\n        this[3] = match[4] | 0;\r\n      } else if (match = args.match(/hsl\\((.*),(.*),(.*)\\)/)) {\r\n        this.fromHsl(match[1], match[2], match[3]);\r\n      } else if (match = args.match(/hsv\\((.*),(.*),(.*)\\)/)) {\r\n        this.fromHsv(match[1], match[2], match[3]);\r\n      }\r\n    } else {\r\n      switch (type) {\r\n        case \"hsl\":\r\n        case \"hsla\":\r\n\r\n          this.fromHsl(args[0], args[1], args[2], args[3]);\r\n          break;\r\n\r\n        case \"hsv\":\r\n        case \"hsva\":\r\n\r\n          this.fromHsv(args[0], args[1], args[2], args[3]);\r\n          break;\r\n\r\n        default:\r\n          this[0] = args[0];\r\n          this[1] = args[1];\r\n          this[2] = args[2];\r\n          this[3] = typeof args[3] === \"undefined\" ? 1.0 : args[3];\r\n          break;\r\n      }\r\n    }\r\n  },\r\n\r\n  a: function(a) {\r\n    return this.alpha(a);\r\n  },\r\n\r\n  alpha: function(a) {\r\n    this[3] = a;\r\n    return this;\r\n  },\r\n\r\n  fromHsl: function() {\r\n    var components = arguments[0] instanceof Array ? arguments[0] : arguments;\r\n\r\n    var color = cq.hslToRgb(parseFloat(components[0]), parseFloat(components[1]), parseFloat(components[2]));\r\n\r\n    this[0] = color[0];\r\n    this[1] = color[1];\r\n    this[2] = color[2];\r\n    this[3] = typeof arguments[3] === \"undefined\" ? 1.0 : arguments[3];\r\n  },\r\n\r\n  fromHsv: function() {\r\n    var components = arguments[0] instanceof Array ? arguments[0] : arguments;\r\n    var color = cq.hsvToRgb(parseFloat(components[0]), parseFloat(components[1]), parseFloat(components[2]));\r\n\r\n    this[0] = color[0];\r\n    this[1] = color[1];\r\n    this[2] = color[2];\r\n    this[3] = typeof arguments[3] === \"undefined\" ? 1.0 : arguments[3];\r\n  },\r\n\r\n  toArray: function() {\r\n    return [this[0], this[1], this[2], this[3]];\r\n  },\r\n\r\n  toRgb: function() {\r\n    return \"rgb(\" + this[0] + \", \" + this[1] + \", \" + this[2] + \")\";\r\n  },\r\n\r\n  toRgba: function() {\r\n    return \"rgba(\" + this[0] + \", \" + this[1] + \", \" + this[2] + \", \" + this[3] + \")\";\r\n  },\r\n\r\n  toHex: function() {\r\n    return cq.rgbToHex(this[0], this[1], this[2]);\r\n  },\r\n\r\n  toHsl: function() {\r\n    var c = cq.rgbToHsl(this[0], this[1], this[2]);\r\n    c[3] = this[3];\r\n    return c;\r\n  },\r\n\r\n  toHsv: function() {\r\n    var c = cq.rgbToHsv(this[0], this[1], this[2]);\r\n    c[3] = this[3];\r\n    return c;\r\n  },\r\n\r\n  gradient: function(target, steps) {\r\n    var targetColor = cq.color(target);\r\n  },\r\n\r\n  shiftHsl: function() {\r\n    var hsl = this.toHsl();\r\n\r\n    if (this[0] !== this[1] || this[1] !== this[2]) {\r\n      var h = arguments[0] === false ? hsl[0] : cq.wrapValue(hsl[0] + arguments[0], 0, 1);\r\n      var s = arguments[1] === false ? hsl[1] : cq.limitValue(hsl[1] + arguments[1], 0, 1);\r\n    } else {\r\n      var h = hsl[0];\r\n      var s = hsl[1];\r\n    }\r\n\r\n    var l = arguments[2] === false ? hsl[2] : cq.limitValue(hsl[2] + arguments[2], 0, 1);\r\n\r\n    this.fromHsl(h, s, l);\r\n\r\n    return this;\r\n  },\r\n\r\n  setHsl: function() {\r\n    var hsl = this.toHsl();\r\n\r\n    var h = arguments[0] === false ? hsl[0] : cq.limitValue(arguments[0], 0, 1);\r\n    var s = arguments[1] === false ? hsl[1] : cq.limitValue(arguments[1], 0, 1);\r\n    var l = arguments[2] === false ? hsl[2] : cq.limitValue(arguments[2], 0, 1);\r\n\r\n    this.fromHsl(h, s, l);\r\n\r\n    return this;\r\n  },\r\n\r\n  mix: function(color, amount) {\r\n    color = cq.color(color);\r\n\r\n    for (var i = 0; i < 4; i++)\r\n      this[i] = cq.mix(this[i], color[i], amount);\r\n\r\n    return this;\r\n  }\r\n\r\n};\r\n\r\nmodule.exports = cq;\r\n"
  ]
}